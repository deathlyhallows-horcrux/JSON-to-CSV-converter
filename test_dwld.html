<html>
<head>
    <title>Demo - Convert JSON data to CSV file and download</title>
    <script type="text/javascript" src="http://code.jquery.com/jquery-latest.js"></script>
     <script type="text/javascript" src="json2.js"></script>

    <script type="text/javascript">
var b = '';
var loc = [];  //object
        // JSON to CSV Converter
        function ConvertToCSV(objArray) {
            var array = typeof objArray != 'object' ? JSON.parse(objArray) : objArray;
            var str = '';

            for (var i = 0; i < array.length; i++) {
                var line = '';
                for (var index in array[i]) {
                    if (line != '') line += ','

                    line += array[i][index];
                }

                str += line + '\r\n';

            }

            return str;
        }

        // Example
        $(document).ready(function () {
       

           //console.log(typeof(loc));
           
var increment = (function () {
    var n = -10;
    return function () {
        n += 10;
        return n;
    }
}());

     (function store(){
      var stores = [];

 var  x = increment();   
console.log(x);
        $.ajax({url: 'https://www.paxvapor.com/locator/index/getstores/',
            data: {lat:32, lng:118, count: x},
              success: function(result){
               debugger;
if(x >0){
 // var jsonagain = csvJSON(b);
  //$('#json').text(jsonagain);
 download(b);
}
else{ 
var loc = result;
//Json2CSV(loc);
showdata(loc); //callback
store();
   }
 


        }});
 

    }());
  
            // Create Object
            var items = [
                  { name: "Item 1", color: "Green", size: "X-Large" },
                  { name: "Item 2", color: "Green", size: "X-Large" },
                  { name: "Item 3", color: "Green", size: "X-Large" }];

            // Convert Object to JSON
            var jsonObject = JSON.stringify(loc);

            // Display JSON
            $('#json').text(loc);

            // Convert JSON to CSV & Display CSV
           
        });

function showdata(loc){
var a = ConvertToCSV(loc);
//console.log(typeof(a));

b =  b + a;
$('#csv').text(b);
 //download(b);
}
function getkeys(obj){
var keys = [];
for(var key in obj){
keys.push(key);
}
return keys.join();
}

function download(csv){
  a=document.createElement('a');
a.textContent='download';
a.download="myFileName.csv";
a.href='data:text/csv;charset=utf-8,'+escape(csv);
document.body.appendChild(a);
      }

      //csv to json

      function csvJSON(csv){

  var lines=csv.split("\n");

  var result = [];

  var headers=lines[0].split(",");

  for(var i=1;i<lines.length;i++){

    var obj = {};
    var currentline=lines[i].split(",");

    for(var j=0;j<headers.length;j++){
      obj[headers[j]] = currentline[j];
    }

    result.push(obj);

  }
  
  //return result; //JavaScript object
  return JSON.stringify(result); //JSON
}
    </script>
</head>
<body>
    <h1>
        JSON</h1>
    <pre id="json"></pre>
    <h1>
        CSV</h1>
    <pre id="csv"></pre>
</body>
</html>